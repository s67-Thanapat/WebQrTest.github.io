<!DOCTYPE html>
<html lang="th" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QR ‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</title>
  <style>
    :root{ --bg:#0b0c10; --fg:#e5e7eb; --muted:#9ca3af; --card:#111318; --shadow:0 8px 32px rgba(0,0,0,.45); }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      min-height:100dvh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px;
      padding:24px;
    }
    .title{font-weight:800; letter-spacing:.2px; text-align:center; margin:0;}
    .size{color:var(--muted); font-weight:700; letter-spacing:.2px; text-align:center;}
    .qr-box{
      display:flex; align-items:center; justify-content:center;
      background:var(--card); padding:18px; border-radius:22px; box-shadow:var(--shadow);
      width:min(78vw, 360px); height:min(78vw, 360px);
    }
    #qrCanvas canvas, #qrCanvas img{
      width:100%; height:100%; border-radius:16px; background:#fff; display:block;
    }
    .uuid{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.95rem; color:var(--muted);
      word-break:break-all; text-align:center; }
    .countdown{ font-weight:800; letter-spacing:.2px; }
    .toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      padding:10px 14px; border-radius:12px; background:rgba(0,0,0,.85); color:#fff; z-index:9999; }
  </style>

  <!-- ‚úÖ qrcodejs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1 class="title">‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</h1>
  <h1 class="title" style="color:#FF0000;">*‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏≤‡∏¢*</h1>

  <div id="sizeLabel" class="size">‡∏Ç‡∏ô‡∏≤‡∏î: ‚Äî</div>
  <div class="qr-box"><div id="qrCanvas" aria-label="QR"></div></div>
  <div class="uuid" id="uuidText">‚Äî</div>

  <!-- üîî ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á -->
  <div class="countdown" aria-live="polite">
    ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô: <span id="count">‚Äî</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  </div>

<script>
(function(){
  // ==== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ====
  const SUPABASE_URL = "https://yowjvmiosrclqstoeqat.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";
  const supabase = window.supabase.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);

  const PERIOD_MS = 30_000;  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥
  const QR_PX = 512;         // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ
  const QUIET_MARGIN = 4;    // ‚úÖ Quiet Zone (‡∏´‡∏ô‡πà‡∏ß‡∏¢ = ‡πÇ‡∏°‡∏î‡∏π‡∏•) ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 4

  // ==== ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á DOM ====
  const sizeLabel = document.getElementById('sizeLabel');
  const uuidText  = document.getElementById('uuidText');
  const countEl   = document.getElementById('count');
  const qrBox     = document.getElementById('qrCanvas');

  let nextAt = null;
  let ticker = null;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏°‡∏µ 0/O/I/1)
  function shortId(len){
    const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    const arr = new Uint32Array(len);
    crypto.getRandomValues(arr);
    return Array.from(arr).map(v => alphabet[v % alphabet.length]).join('');
  }

  // ‡∏ß‡∏≤‡∏î QR + Quiet Zone
  function drawQR(text){
    qrBox.innerHTML = '';
    new QRCode(qrBox, {
      text,
      width: QR_PX,
      height: QR_PX,
      correctLevel: QRCode.CorrectLevel.M,
      colorDark: "#000000",
      colorLight: "#ffffff",
      margin: QUIET_MARGIN // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Quiet Zone ‡∏£‡∏≠‡∏ö‡πÜ ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏°‡∏î‡∏π‡∏•
    });
    sizeLabel.textContent = `‡∏Ç‡∏ô‡∏≤‡∏î: ${QR_PX}√ó${QR_PX} px`;
  }

  // ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Supabase (REST)
  async function sendToSupabase(code){
    if (!supabase) return;
    const payload = [{ uuid: code, user_agent: navigator.userAgent }];
    await fetch(`${SUPABASE_URL}/rest/v1/qr_codes`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        "Content-Type": "application/json",
        Prefer: "return=representation"
      },
      body: JSON.stringify(payload)
    });
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÉ‡∏´‡∏°‡πà
  async function generateQR(){
    const code = shortId(12);
    uuidText.textContent = code;
    drawQR(code);
    try{ await sendToSupabase(code); }catch(e){ console.error(e); }
    nextAt = Date.now() + PERIOD_MS;
  }

  // ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  function startTicker(){
    if (ticker) clearInterval(ticker);
    ticker = setInterval(()=>{
      if (!nextAt){ countEl.textContent = '‚Äî'; return; }
      const remain = Math.max(0, nextAt - Date.now());
      const sec = Math.ceil(remain / 1000);
      countEl.textContent = String(sec);
      if (remain <= 0){ generateQR(); }
    }, 250);
  }

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  generateQR();
  startTicker();
})();
</script>
</body>
</html>
