<!DOCTYPE html>
<html lang="th" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QR สุ่มอัตโนมัติ • ป้ายทะเบียน 4 หลัก</title>
  <style>
    :root{
      --bg:#0b0c10;
      --fg:#e5e7eb;
      --muted:#9ca3af;
      --shadow:0 8px 32px rgba(0,0,0,.45);
      --qr-size: 250px;
      --frame: 20px;
      --radius: 16px;

      --btn:#2563eb;
      --btn-hover:#1e40af;
      --btn-text:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      min-height:100dvh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px;
      padding:24px;
    }
    .title{font-weight:800; text-align:center; margin:0;}
    .warn{color:#ff6b6b; font-weight:800; margin:0; text-align:center}
    .plate{
      font-size:1.5rem; font-weight:900; color:#4ade80; text-align:center; letter-spacing:.6px; margin:8px 0;
    }
    .toolbar{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:8px}
    .btn{
      appearance:none; border:0; cursor:pointer; background:var(--btn); color:var(--btn-text);
      font-weight:700; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); transition:.18s ease;
    }
    .btn:hover{ background:var(--btn-hover); transform:translateY(-1px) }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none }
    .size{color:var(--muted); font-weight:700; text-align:center;}
    .qr-frame{ background:#ffffff; padding:var(--frame); border-radius:var(--radius); box-shadow:var(--shadow); display:inline-block; }
    .qr-box{ width:var(--qr-size); height:var(--qr-size); display:flex; align-items:center; justify-content:center; }
    #qrCanvas canvas, #qrCanvas img{ width:100%; height:100%; background:#fff; display:block; border-radius:calc(var(--radius) - 6px); }
    .uuid{
      font-family:ui-monospace,Menlo,Consolas,monospace; font-size:1.05rem; color:#ffffff; letter-spacing:.4px; text-align:center;
      background:#111318; padding:8px 12px; border-radius:10px; box-shadow:var(--shadow); min-width:180px; margin-top:10px; word-break:break-all;
    }
    .countdown{ font-weight:800; }
    .status{ font-size:.9rem; text-align:center; margin-top:6px; color:var(--muted); }
  </style>

  <!-- qrcodejs + supabase -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1 class="title">หมายเลขของคุณ</h1>

  <!-- ป้ายทะเบียนอยู่เหนือข้อความเตือน -->
  <div class="plate" id="plateCode">—</div>
  <h2 class="warn">*สำคัญห้ามหาย*</h2>

  <div class="toolbar">
    <div id="sizeLabel" class="size">ขนาด: —</div>
  </div>

  <div class="qr-frame">
    <div class="qr-box"><div id="qrCanvas" aria-label="QR"></div></div>
  </div>

  <!-- UUID 12 หลักอยู่ใต้ QR -->
  <div class="uuid" id="uuidText">—</div>

  <div class="countdown" aria-live="polite">
    จะสร้างใหม่ใน: <span id="count">—</span> วินาที
  </div>

  <!-- ปุ่มสุ่มทันที -->
  <div><button id="btnNow" class="btn" type="button">สุ่มทันที</button></div>

  <!-- แสดงสถานะการบันทึก (สำคัญสำหรับ debug) -->
  <div id="saveStatus" class="status">—</div>

<script>
(function(){
  // ====== CONFIG: ใช้ค่าจริงของคุณ ======
  const SUPABASE_URL = "https://yowjvmiosrclqstoeqat.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";

  // สร้าง client
  const supabase = window.supabase.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);

  const PERIOD_MS = 30_000;
  const QR_PX = 250;
  const QUIET_MARGIN = 4;

  const plateEl   = document.getElementById('plateCode');
  const uuidEl    = document.getElementById('uuidText');
  const sizeLabel = document.getElementById('sizeLabel');
  const countEl   = document.getElementById('count');
  const qrBox     = document.getElementById('qrCanvas');
  const btnNow    = document.getElementById('btnNow');
  const statusEl  = document.getElementById('saveStatus');

  let nextAt = null;
  let ticker = null;
  let currentPlate = null;

  // ====== Helpers ======
  // UUID 12 ตัวอักษร/ตัวเลข (A-Z, 0-9)
  function shortUUID(len=12){
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    const arr = new Uint32Array(len);
    crypto.getRandomValues(arr);
    return Array.from(arr).map(v => chars[v % chars.length]).join('');
  }

  // เดินหน้า A001 -> A002 -> ... -> A999 -> B001 -> ... -> Z999 -> A001
  function nextPlate(code){
    if(!code || !/^[A-Z][0-9]{3}$/.test(code)) code = "A000";
    let letter = code[0];
    let num = parseInt(code.slice(1), 10);
    num += 1;
    if(num > 999){
      num = 1;
      letter = String.fromCharCode(letter.charCodeAt(0) + 1);
      if(letter > 'Z'){ letter = 'A'; }
    }
    return letter + String(num).padStart(3, '0');
  }

  function drawQR(text){
    qrBox.innerHTML = '';
    new QRCode(qrBox, {
      text,
      width: QR_PX,
      height: QR_PX,
      correctLevel: QRCode.CorrectLevel.M,
      colorDark: "#000000",
      colorLight: "#ffffff",
      margin: QUIET_MARGIN
    });
    sizeLabel.textContent = `ขนาด: ${QR_PX}×${QR_PX} px`;
  }

  // ====== บันทึกลง DB: public.qrcodes(user_agent, code) ======
  async function savePlateToDB(plate){
    if(!supabase){
      console.warn('supabase client not ready');
      statusEl.textContent = '❌ Supabase client not ready';
      statusEl.style.color = '#f87171';
      return;
    }

    // ถ้าคอลัมน์ code มี UNIQUE constraint และอยากอัปเดตทับ ให้ใช้ upsert + onConflict: 'code'
    // ตัวอย่าง: .upsert({ user_agent: plate, code: plate }, { onConflict: 'code' })
    const { data, error, status } = await supabase
      .from('qrcodes')
      .insert({ user_agent: plate, code: plate })   // ✅ เติม code ด้วยค่า plate
      .select();

    if(error){
      console.error('Insert error:', error, 'HTTP status:', status);
      statusEl.textContent = `❌ Insert error (${status}): ${error.message}`;
      statusEl.style.color = '#f87171';
      return;
    }

    console.log('Inserted:', data);
    statusEl.textContent = `✅ Saved: ${plate}`;
    statusEl.style.color = '#34d399';
  }

  // ====== สุ่ม/เดินหน้า และอัปเดตจอ ======
  async function generate({manual=false} = {}){
    // เดินหน้า plate
    currentPlate = nextPlate(currentPlate);
    plateEl.textContent = currentPlate;

    // UUID 12 หลักใหม่ทุกครั้ง (แสดงผลอย่างเดียว)
    const uuid12 = shortUUID(12);
    uuidEl.textContent = uuid12;

    // วาด QR ด้วยข้อความเป็น plate
    drawQR(currentPlate);

    // ⭐ บันทึกลงฐานข้อมูล
    await savePlateToDB(currentPlate);

    // รีเซ็ตตัวนับเวลา
    nextAt = Date.now() + PERIOD_MS;

    // กันกดรัว
    if(manual){
      btnNow.disabled = true;
      setTimeout(()=> btnNow.disabled = false, 600);
    }
  }

  function startTicker(){
    if(ticker) clearInterval(ticker);
    ticker = setInterval(()=>{
      if (!nextAt){ countEl.textContent = '—'; return; }
      const remain = Math.max(0, nextAt - Date.now());
      const sec = Math.ceil(remain/1000);
      countEl.textContent = sec;
      if(remain <= 0){ generate(); }
    }, 250);
  }

  // ====== เริ่มต้น ======
  (async function init(){
    console.log('SUPABASE_URL:', SUPABASE_URL);
    currentPlate = "A000";  // เริ่มให้กลายเป็น A001 ในการ generate ครั้งแรก
    await generate();
    btnNow.addEventListener('click', ()=> generate({manual:true}));
    startTicker();
  })();
})();
</script>
</body>
</html>
