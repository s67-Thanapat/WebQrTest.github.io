<!DOCTYPE html>
<html lang="th" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QR สุ่มอัตโนมัติ</title>
  <style>
    :root{
      --bg:#0b0c10;        /* พื้นหลังหน้า (ดำ) */
      --fg:#e5e7eb;
      --muted:#9ca3af;
      --shadow:0 8px 32px rgba(0,0,0,.45);
      --qr-size: 512px;    /* ✅ ขนาดตัวภาพ QR (ไม่รวมกรอบ) */
      --frame: 20px;       /* ✅ ความหนากรอบสีขาวรอบ QR */
      --radius: 16px;      /* มุมโค้งกรอบ */
    }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      min-height:100dvh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px;
      padding:24px;
    }
    .title{font-weight:800; letter-spacing:.2px; text-align:center; margin:0;}
    .size{color:var(--muted); font-weight:700; letter-spacing:.2px; text-align:center;}

    /* ✅ กรอบสีขาวรอบ QR */
    .qr-frame{
      background:#ffffff;                 /* กรอบสีขาว */
      padding:var(--frame);               /* ความหนากรอบ */
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      display:inline-block;
    }

    /* กล่องสำหรับวาง QR (ขนาดพอดีกับ --qr-size) */
    .qr-box{
      width:var(--qr-size);
      height:var(--qr-size);
      display:flex; align-items:center; justify-content:center;
    }

    /* ตัวแคนวาส/รูปของ lib qrcodejs */
    #qrCanvas canvas, #qrCanvas img{
      width:100%; height:100%;
      background:#fff;                    /* ✅ พื้นหลัง + Quiet Zone = ขาว */
      display:block;
      border-radius:calc(var(--radius) - 6px);
    }

    .uuid{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:.95rem; color:var(--muted);
      word-break:break-all; text-align:center;
    }
    .countdown{ font-weight:800; letter-spacing:.2px; }
  </style>

  <!-- qrcodejs + supabase -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1 class="title">คิวอาร์โค้ด</h1>
  <h1 class="title" style="color:#FF0000;">*สำคัญห้ามหาย*</h1>

  <div id="sizeLabel" class="size">ขนาด: —</div>

  <!-- ✅ กรอบขาวครอบ QR -->
  <div class="qr-frame">
    <div class="qr-box"><div id="qrCanvas" aria-label="QR"></div></div>
  </div>

  <div class="uuid" id="uuidText">—</div>

  <!-- ตัวนับถอยหลัง -->
  <div class="countdown" aria-live="polite">
    สุ่มใหม่ใน: <span id="count">—</span> วินาที
  </div>

<script>
(function(){
  // ==== ตั้งค่า ====
  const SUPABASE_URL = "https://yowjvmiosrclqstoeqat.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";
  const supabase = window.supabase.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);

  const PERIOD_MS = 30_000;              // เปลี่ยนทุก 30 วิ
  const QR_PX = 512;                     // ✅ ต้องตรงกับ --qr-size
  const QUIET_MARGIN = 4;                // ✅ Quiet Zone = 4 โมดูล (มาตรฐาน)

  // ==== อ้างอิง DOM ====
  const sizeLabel = document.getElementById('sizeLabel');
  const uuidText  = document.getElementById('uuidText');
  const countEl   = document.getElementById('count');
  const qrBox     = document.getElementById('qrCanvas');

  let nextAt = null;
  let ticker = null;

  // รหัสอ่านง่าย (ตัด 0/O/I/1 ออก)
  function shortId(len){
    const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    const arr = new Uint32Array(len);
    crypto.getRandomValues(arr);
    return Array.from(arr).map(v => alphabet[v % alphabet.length]).join('');
  }

  // วาด QR + Quiet Zone สีขาว
  function drawQR(text){
    qrBox.innerHTML = '';
    new QRCode(qrBox, {
      text,
      width: QR_PX,
      height: QR_PX,
      correctLevel: QRCode.CorrectLevel.M,
      colorDark: "#000000",   // จุด QR
      colorLight: "#ffffff",  // ✅ พื้นหลัง + Quiet Zone = ขาว
      margin: QUIET_MARGIN    // ✅ ความกว้าง Quiet Zone (หน่วย = โมดูล)
    });
    sizeLabel.textContent = `ขนาด: ${QR_PX}×${QR_PX} px`;
  }

  // ส่งขึ้น Supabase (REST)
  async function sendToSupabase(code){
    if (!supabase) return;
    const payload = [{ uuid: code, user_agent: navigator.userAgent }];
    await fetch(`${SUPABASE_URL}/rest/v1/qr_codes`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        "Content-Type": "application/json",
        Prefer: "return=representation"
      },
      body: JSON.stringify(payload)
    });
  }

  // สร้าง QR ใหม่
  async function generateQR(){
    const code = shortId(12);
    uuidText.textContent = code;
    drawQR(code);
    try{ await sendToSupabase(code); }catch(e){ console.error(e); }
    nextAt = Date.now() + PERIOD_MS;
  }

  // ตัวนับถอยหลัง
  function startTicker(){
    if (ticker) clearInterval(ticker);
    ticker = setInterval(()=>{
      if (!nextAt){ countEl.textContent = '—'; return; }
      const remain = Math.max(0, nextAt - Date.now());
      const sec = Math.ceil(remain / 1000);
      countEl.textContent = String(sec);
      if (remain <= 0){ generateQR(); }
    }, 250);
  }

  // เริ่มทำงาน
  generateQR();
  startTicker();
})();
</script>
</body>
</html>
