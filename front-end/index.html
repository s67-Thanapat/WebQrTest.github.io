<!DOCTYPE html>
<html lang="th" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QR ‡∏™‡∏∏‡πà‡∏° ‚Ä¢ ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ + ‡∏õ‡∏∏‡πà‡∏°</title>
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0c10" />

  <!-- ‚úÖ Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* === (style ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) === */
    :root{
      --bg:#0b0c10; --fg:#e5e7eb; --muted:#9ca3af;
      --card:#111318; --shadow:0 8px 32px rgba(0,0,0,.45);
      --accent:#2563eb;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#ffffff; --fg:#0b0c10; --muted:#6b7280;
        --card:#f5f6f8; --shadow:0 6px 24px rgba(0,0,0,.08);
      }
    }
    html,body{height:100%;}
    body{ margin:0; background:var(--bg); color:var(--fg);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    main.center{ min-height:100dvh; padding:calc(env(safe-area-inset-top) + 12px) 16px calc(env(safe-area-inset-bottom) + 96px);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; }
    .title{font-weight:800; letter-spacing:.2px; text-align:center; margin:0 0 6px;}
    .size{color:var(--muted); font-weight:700; letter-spacing:.2px; text-align:center;}
    .qr-box{ display:flex; align-items:center; justify-content:center;
      background:var(--card); padding:18px; border-radius:22px; box-shadow:var(--shadow);
      min-height: calc(min(78vw, 360px) + 36px); }
    img.qr{ width:min(78vw, 360px); aspect-ratio:1/1; border-radius:16px; background:#fff; display:block; }
    .uuid{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.95rem; color:var(--muted);
      word-break:break-all; text-align:center; }
    .btns{ display:flex; justify-content:center; align-items:center; gap:10px; width:min(92vw, 440px); flex-wrap:wrap; }
    button{ appearance:none; border:none; cursor:pointer;
      padding:12px 14px; border-radius:14px; font-weight:800;
      background:var(--accent); color:#fff; box-shadow:var(--shadow); min-height:44px; }
    .btn-dark{background:#111827;} .btn-good{background:#16a34a;}
    .btn-admin-left{ position:fixed; top:calc(10px + env(safe-area-inset-top)); left:12px; z-index:1000;
      background:#f59e0b; color:#111; font-weight:800; border:none; padding:10px 14px; border-radius:14px;
      box-shadow:var(--shadow); cursor:pointer; }
    .btn-float-right{ position:fixed; top:calc(10px + env(safe-area-inset-top));
      right:12px; z-index:1000; background:#0ea5e9; }
    .btn-play{ position:fixed; bottom:calc(16px + env(safe-area-inset-bottom)); left:50%; transform:translateX(-50%);
      width:min(92vw, 440px); z-index:1000; background:#22c55e; font-size:1.05rem; text-align:center;
      padding:10px 14px; border-radius:14px; color:#fff; font-weight:800; }
    .toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      padding:10px 14px; border-radius:12px; background:rgba(0,0,0,.85); color:#fff; z-index:9999; }
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô -->
  <button id="btnAdmin" class="btn-admin-left" type="button">Admin</button>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ -->
  <a href="Extention.html" class="btn-float-right">‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</a>

  <main class="center">
    <h1 class="title">‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</h1>
    <h1 class="title" style="color:#FF0000;">*‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏≤‡∏¢*</h1>

    <div id="sizeLabel" class="size">‡∏Ç‡∏ô‡∏≤‡∏î: ‚Äî</div>
    <div class="qr-box"><img id="qrImg" class="qr" alt="QR"></div>
    <div class="uuid" id="uuidText">‚Äî</div>

    <div class="btns">
      <button id="btnGen">‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</button>
      <button id="btnSave" class="btn-good hidden">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</button>
      <button id="btnCopy" class="btn-dark hidden">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
    </div>
  </main>

  <a id="btnPlay" href="game.html" class="btn-play">‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°</a>

  <!-- ‚úÖ ‡∏ü‡∏≠‡∏£‡πå‡∏° login/logout -->
  <section style="padding:20px; text-align:center;">
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="signup()">Register</button>
    <button onclick="logout()">Logout</button>
    <p id="me">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</p>
  </section>

<script>
(function(){
  // ====== CONFIG ======
  const SUPABASE_URL = "https://<your-project>.supabase.co";   // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const SUPABASE_ANON_KEY = "<your-anon-key>";                 // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const QR_PX = 1024;
  const STORAGE_KEY = 'qr_locked_code_v1';
  const ADMIN_PASS = '12345';

  // ====== Elements ======
  const img = document.getElementById('qrImg');
  const sizeLabel = document.getElementById('sizeLabel');
  const uuidText = document.getElementById('uuidText');
  const btnGen = document.getElementById('btnGen');
  const btnSave = document.getElementById('btnSave');
  const btnCopy = document.getElementById('btnCopy');

  // ====== Helpers ======
  function toast(msg){
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 1400);
  }

  function shortId(len){
    const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    const arr = new Uint32Array(len);
    crypto.getRandomValues(arr);
    return Array.from(arr).map(v => alphabet[v % alphabet.length]).join('');
  }

  function drawQR(text){
    const base = 'https://api.qrserver.com/v1/create-qr-code/';
    img.src = base + '?size=' + QR_PX + 'x' + QR_PX + '&format=png&qzone=2&margin=2&data=' + encodeURIComponent(text);
    sizeLabel.textContent = '‡∏Ç‡∏ô‡∏≤‡∏î: ' + QR_PX + '√ó' + QR_PX + ' px';
  }

  function applyLockedUI(code){
    if (!code) return;
    uuidText.textContent = code;
    drawQR(code);
    btnGen.classList.add('hidden');
    btnSave.classList.remove('hidden');
    btnCopy.classList.remove('hidden');
  }

  // ====== Supabase Auth ======
  async function login(){
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return alert(error.message);
    toast("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    showMe();
  }
  async function signup(){
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) return alert(error.message);
    alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•");
  }
  async function logout(){
    await supabase.auth.signOut();
    toast("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
    showMe();
  }
  async function showMe(){
    const { data: { user } } = await supabase.auth.getUser();
    document.getElementById("me").textContent = user ? `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ${user.email}` : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô";
  }
  supabase.auth.onAuthStateChange(showMe);

  // ====== Insert QR (‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Supabase DB ‡∏î‡πâ‡∏ß‡∏¢ user token) ======
  async function sendToSupabase(code){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");

    const accessToken = session.access_token;
    const payload = [{ uuid: code, user_agent: navigator.userAgent }];

    const res = await fetch(`${SUPABASE_URL}/rest/v1/qr_codes`, { // üëà ‡πÉ‡∏ä‡πâ table ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      method: "POST",
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${accessToken}`,   // ‚úÖ ‡∏™‡πà‡∏á user token
        "Content-Type": "application/json",
        Prefer: "return=representation"
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // ====== Actions ======
  async function handleGenerateOnce(){
    try {
      const code = shortId(12);
      await sendToSupabase(code);   // ‚úÖ ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ audit log ‡∏û‡∏£‡πâ‡∏≠‡∏° changed_by
      applyLockedUI(code);
      toast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    } catch(e){
      console.error(e);
      toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    }
  }

  function savePNG(){ /* (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) */ }
  function copyCode(){ /* (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) */ }

  // Events
  btnGen?.addEventListener('click', handleGenerateOnce);
  btnSave?.addEventListener('click', savePNG);
  btnCopy?.addEventListener('click', copyCode);

  showMe();
})();
</script>
</body>
</html>
