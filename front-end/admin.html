<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - QR Codes</title>
  <style>
    :root{ --bg:#0b0c10; --fg:#e5e7eb; --muted:#9ca3af; --card:#111318; --accent:#2563eb; --accent-2:#1d4ed8; --danger:#dc2626; --border:rgba(255,255,255,.08); }
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:20px auto;padding:16px}
    h1{margin:0 0 12px}
    .bar{display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);padding:10px;border-radius:12px}
    .spacer{flex:1}
    input[type="text"]{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg)}
    button{padding:8px 12px;border:none;border-radius:10px;cursor:pointer}
    .btn{background:var(--accent);color:#fff}.btn:hover{background:var(--accent-2)}
    .btn-ghost{background:transparent;color:var(--fg);border:1px solid var(--border)}
    .btn-del{background:var(--danger);color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid var(--border);padding:10px;text-align:left}
    th{background:#14161d}
    tr:nth-child(even){background:#0f1117}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .foot{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
    select{background:transparent;color:var(--fg);border:1px solid var(--border);border-radius:8px;padding:6px}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55)}
    .modal.show{display:grid}
    .card{background:var(--card);border:1px solid var(--border);padding:16px;border-radius:12px;min-width:320px}
    .card h3{margin:0 0 10px}
    .card label{font-size:12px;color:var(--muted)}
    .card input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg)}
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - QR Codes</h1>

    <div class="bar">
      <button class="btn" id="btnReload">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="btn-ghost" id="btnExport">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
      <button class="btn-del" id="btnBulkDelete">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      <span class="spacer"></span>
      <input id="search" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: id / code / user agent" />
      <button class="btn-ghost" id="btnCheckMe">üîé ‡πÄ‡∏ó‡∏™ backend</button>
      <button class="btn-ghost" id="btnResetPw">üîë ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
      <button class="btn-ghost" id="btnLogout">üö™ Logout</button>
    </div>

    <table id="qrTable" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ QR Codes">
      <thead>
        <tr>
          <th style="width:36px"><input type="checkbox" id="checkAll"></th>
          <th>ID</th>
          <th>Code</th>
          <th>User Agent</th>
          <th>Created At</th>
          <th class="right">Action</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td class="muted" colspan="6">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
    </table>

    <div class="foot">
      <div id="countLabel" class="muted">‚Äî</div>
      <div>‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
        <select id="pageSize"><option>10</option><option selected>20</option><option>50</option><option>100</option></select>
        <span id="pageInfo" class="muted" style="margin-left:8px">‡∏´‡∏ô‡πâ‡∏≤ 1/1</span>
      </div>
    </div>
  </div>

  <!-- Modal Reset Password -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="card">
      <h3>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
      <label>Email</label>
      <input id="mEmail" type="email" placeholder="user@example.com" />
      <label style="margin-top:8px">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
      <input id="mPassword" type="password" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß" />
      <div id="mMsg" class="muted" style="margin-top:6px"></div>
      <div class="row">
        <button class="btn-ghost" id="mCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn" id="mSubmit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = "https://yowjvmiosrclqstoeqat.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY"; // ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
const BACKEND_BASE = "http://127.0.0.1:8000";     // ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö backend

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/* ---------- ELEMENTS ---------- */
const tbody = document.getElementById("tbody");
const btnReload = document.getElementById("btnReload");
const btnExport = document.getElementById("btnExport");
const btnBulkDelete = document.getElementById("btnBulkDelete");
const btnLogout = document.getElementById("btnLogout");
const btnCheckMe = document.getElementById("btnCheckMe");
const search = document.getElementById("search");
const checkAll = document.getElementById("checkAll");
const pageSize = document.getElementById("pageSize");
const pageInfo = document.getElementById("pageInfo");
const countLabel = document.getElementById("countLabel");
const tzFmt = new Intl.DateTimeFormat('th-TH',{dateStyle:'medium', timeStyle:'medium', hour12:false, timeZone:'Asia/Bangkok'});

/* Modal elems */
const modal = document.getElementById("modal");
const mEmail = document.getElementById("mEmail");
const mPassword = document.getElementById("mPassword");
const mMsg = document.getElementById("mMsg");
document.getElementById("btnResetPw").onclick = () => { mEmail.value=""; mPassword.value=""; mMsg.textContent=""; modal.classList.add("show"); };
document.getElementById("mCancel").onclick = () => modal.classList.remove("show");
document.getElementById("mSubmit").onclick = adminResetPassword;

/* ---------- SESSION GATE ---------- */
(async () => {
  const { data:{ session } } = await supabase.auth.getSession();
  if (!session) { window.location.href = "login.html"; return; }
  loadData();
})();

/* ---------- STATE / RENDER ---------- */
const st = { raw:[], filtered:[], page:1, pageSize:20 };
function fmtDate(iso){const d = new Date(iso);return isNaN(d)? "-" : tzFmt.format(d);}
function applyFilter(){
  const q=(search.value||"").trim().toLowerCase();
  st.filtered = st.raw.filter(r=>{
    if(!q) return true;
    return String(r.id).includes(q) ||
           String(r.code||"").toLowerCase().includes(q) ||
           String(r.user_agent||"").toLowerCase().includes(q);
  });
  st.page=1;
}
function getPageData(){const start=(st.page-1)*st.pageSize;return st.filtered.slice(start,start+st.pageSize);}
function render(){
  const rows = getPageData();
  if(rows.length===0){ tbody.innerHTML = `<tr><td colspan="6" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; }
  else{
    tbody.innerHTML = "";
    for(const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="rowcheck" value="${r.id}"></td>
        <td>${r.id}</td>
        <td><span>${r.code ?? ""}</span> <button class="btn-ghost" style="margin-left:6px" data-copy="${r.code??""}">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button></td>
        <td class="muted" title="${r.user_agent||""}">${r.user_agent||"-"}</td>
        <td>${fmtDate(r.created_at)}</td>
        <td class="right"><button class="btn-del" data-del="${r.id}">‡∏•‡∏ö</button></td>`;
      tbody.appendChild(tr);
    }
    tbody.querySelectorAll("[data-copy]").forEach(btn=>btn.onclick=()=>navigator.clipboard?.writeText(btn.dataset.copy||""));
    tbody.querySelectorAll("[data-del]").forEach(btn=>btn.onclick=()=>deleteRow(btn.dataset.del));
  }
  const total = st.filtered.length;
  const pages = Math.max(1, Math.ceil(total/st.pageSize));
  if(st.page>pages) st.page=pages;
  pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${st.page}/${pages}`;
  countLabel.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
}

/* ---------- CRUD ---------- */
async function loadData(){
  tbody.innerHTML = `<tr><td colspan="6" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;
  const { data, error } = await supabase
    .from("qrcodes")
    .select("id, code, user_agent, created_at")
    .order("created_at",{ascending:false})
    .limit(1000);
  if(error){ tbody.innerHTML = `<tr><td colspan="6">‚ùå ${error.message}</td></tr>`; return; }
  st.raw = data||[]; applyFilter(); render();
}

async function deleteRow(id){
  if(!confirm(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (${id})`)) return;
  const { error } = await supabase.from("qrcodes").delete().eq("id", id);
  if(error){ alert("‚ùå "+error.message); return; }
  st.raw = st.raw.filter(x=>String(x.id)!==String(id));
  applyFilter(); render();
}

/* ---------- EXPORT / UI EVENTS ---------- */
btnExport.onclick = ()=>{
  const headers = ["id","code","user_agent","created_at(ISO)","created_at(ICT)"];
  const lines=[headers.join(",")];
  const esc = s => s==null? "" : /[",\n]/.test(String(s)) ? `"${String(s).replace(/"/g,'""')}"` : String(s);
  for(const r of st.filtered){
    lines.push([esc(r.id),esc(r.code??""),esc(r.user_agent??""),esc(r.created_at??""),esc(fmtDate(r.created_at))].join(","));
  }
  const blob=new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download=`qrcodes_${new Date().toISOString().replace(/[:.]/g,"-")}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
btnReload.onclick = loadData;
search.oninput = ()=>{applyFilter();render();};
pageSize.onchange = ()=>{st.pageSize=parseInt(pageSize.value,10); render();};
checkAll.onchange = ()=>{ document.querySelectorAll(".rowcheck").forEach(cb=> cb.checked = checkAll.checked); };
btnBulkDelete.onclick = async ()=>{
  const ids = [...document.querySelectorAll(".rowcheck:checked")].map(cb=>cb.value);
  if(ids.length===0) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
  if(!confirm(`‡∏•‡∏ö ${ids.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) return;
  const { error } = await supabase.from("qrcodes").delete().in("id", ids);
  if(error){ alert("‚ùå " + error.message); return; }
  st.raw = st.raw.filter(x=> !ids.includes(String(x.id)));
  applyFilter(); render();
};
btnLogout.onclick = async ()=>{ await supabase.auth.signOut(); window.location.href="login.html"; };

/* ---------- TEST BACKEND ---------- */
btnCheckMe.onclick = async ()=>{
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô"); return; }
  try{
    const r = await fetch(`${BACKEND_BASE}/admin/me`, { headers: { Authorization: "Bearer " + session.access_token }});
    const j = await r.json();
    alert(`${r.status} ${r.ok?"OK":"ERR"}\n` + JSON.stringify(j,null,2));
  }catch(e){
    alert("fetch error: " + e.message);
  }
};

/* ---------- ADMIN RESET PASSWORD (via backend) ---------- */
async function adminResetPassword(){
  const email = mEmail.value.trim();
  const pw = mPassword.value;
  if(!email || !pw){ mMsg.textContent="‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"; return; }
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ window.location.href="login.html"; return; }
  mMsg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á...";
  try{
    const res = await fetch(`${BACKEND_BASE}/admin/reset-password`,{
      method:"POST",
      headers:{ "Content-Type":"application/json","Authorization":"Bearer "+session.access_token },
      body: JSON.stringify({ email, new_password: pw })
    });
    const out = await res.json().catch(()=> ({}));
    if(!res.ok){ mMsg.textContent = "‚ùå " + (out.error || JSON.stringify(out)); return; }
    mMsg.textContent = "‚úÖ " + (out.message || "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    setTimeout(()=> modal.classList.remove("show"), 800);
  }catch(err){
    console.error("reset-password fetch error:", err);
    mMsg.textContent = "‚ùå network error: " + err.message;
  }
}
</script>
</body>
</html>
