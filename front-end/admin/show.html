<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Check-ins by Date (status = IN)</title>
<style>
  :root{
    --bg:#f7f8fc; --fg:#0b1220; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
    --accent:#2563eb; --danger:#dc2626; --board-h:#f1f5f9; --glow:0 6px 18px rgba(2,6,23,.06);
    --chip:#f8fafc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  h1{text-align:center;margin:0 0 14px;font-size:22px}
  .info-bar{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;
    background:var(--card);border:1px solid var(--border);border-radius:14px;
    box-shadow:var(--glow);padding:12px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);
    border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-weight:700}
  .clock{font-weight:800}
  .btn-del{background:var(--danger);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  select{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:600}
  .board{margin-top:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--glow)}
  .chart-container{position:relative;height:380px;width:100%;max-width:980px;margin:8px auto}
  .muted{color:var(--muted);margin:0 16px 8px}
  @media(max-width:720px){.chart-container{height:300px}}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
</head>
<body>
<div class="wrap">
  <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ Check-in ‡∏ï‡πà‡∏≠‡∏ö‡∏π‡∏ò (status = IN)</h1>

  <div class="info-bar">
    <div class="chip">‚úÖ ‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô (IN): <span id="totalIn">‚Äî</span></div>
    <div class="chip">üß© ‡∏ö‡∏π‡∏ò‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalBooths">‚Äî</span></div>
    <div class="chip">üßæ genqrcode ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalGenQR">‚Äî</span></div>
    <div class="chip">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <span id="selectedDateText">‚Äî</span></div>
    <select id="dateSelect"></select>
    <div class="chip clock" id="clock">--:--:--</div>
    <button class="btn-del" id="btnLogout">Logout</button>
  </div>

  <div class="board">
    <h2 style="padding:12px 16px 0;margin:0">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‚Äú‡∏Ñ‡∏£‡∏±‡πâ‡∏á‚Äù ‡∏ó‡∏µ‡πà Check-in (status = IN) ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏π‡∏ò</h2>
    <p class="muted">* ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå <b>checkin_time</b> ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á <b>checkins</b></p>
    <div class="chart-container"><canvas id="chart"></canvas></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL="https://yowjvmiosrclqstoeqat.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const tz = "Asia/Bangkok";
const fmtFull = new Intl.DateTimeFormat("th-TH",{dateStyle:"medium",timeStyle:"medium",hour12:false,timeZone:tz});
const fmtDateTH = new Intl.DateTimeFormat("th-TH",{dateStyle:"medium",timeZone:tz});

/* ===== ELEMENTS ===== */
const elClock=document.getElementById("clock");
const elTotalIn=document.getElementById("totalIn");
const elTotalBooths=document.getElementById("totalBooths");
const elTotalGenQR=document.getElementById("totalGenQR");
const elDateSelect=document.getElementById("dateSelect");
const elDateText=document.getElementById("selectedDateText");
const btnLogout=document.getElementById("btnLogout");
const canvas=document.getElementById("chart");
let chart;

/* ===== CLOCK (‡∏ß‡∏±‡∏ô+‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢) ===== */
function tick(){ elClock.textContent = fmtFull.format(new Date()); }
tick();
setInterval(tick,1000);

/* ===== HELPER ===== */
function normalizeBoothName(s){
  if(!s) return "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ê‡∏≤‡∏ô)";
  return s.trim().replace(/\s+/g," ").toLowerCase();
}
function toLocalDateOnly(iso){
  const d=new Date(iso);
  return d.toLocaleDateString("en-CA",{timeZone:tz}); // yyyy-MM-dd
}

/* ===== GENQRCODE SUMMARY ===== */
async function loadGenQR(){
  const { count } = await supabase.from("genqrcode").select("id",{count:"exact",head:true});
  elTotalGenQR.textContent = count ?? "‚Äî";
}

/* ===== LOAD DATES FROM checkins ===== */
async function loadAvailableDates(){
  const { data, error } = await supabase.from("checkins").select("checkin_time").order("checkin_time",{ascending:true});
  if(error){alert("‡πÇ‡∏´‡∏•‡∏î checkin_time ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: "+error.message);return [];}
  const set=new Set();
  for(const r of data){ if(r.checkin_time) set.add(toLocalDateOnly(r.checkin_time)); }
  const list=[...set].sort();
  elDateSelect.innerHTML=list.map(d=>`<option value="${d}">${fmtDateTH.format(new Date(d))}</option>`).join("");
  return list;
}

/* ===== LOAD CHART ===== */
async function loadChartByDate(dateStr){
  await loadGenQR();
  if(!dateStr) return;
  elDateText.textContent = fmtDateTH.format(new Date(dateStr));

  const start = new Date(dateStr+"T00:00:00+07:00").toISOString();
  const end = new Date(new Date(dateStr+"T00:00:00+07:00").getTime()+86400000).toISOString();

  const { data, error } = await supabase
    .from("checkins")
    .select("booth,status,checkin_time")
    .eq("status","IN")
    .gte("checkin_time", start)
    .lt("checkin_time", end)
    .range(0,99999);

  if(error){alert("‡πÇ‡∏´‡∏•‡∏î checkins ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+error.message);return;}
  const map=new Map();
  for(const r of data){
    const booth=(r.booth?.trim()||"(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ê‡∏≤‡∏ô)");
    const norm=normalizeBoothName(booth);
    if(!map.has(norm)) map.set(norm,{names:new Set(),count:0});
    const o=map.get(norm);
    o.names.add(booth);
    o.count++;
  }

  elTotalIn.textContent=data.length||0;
  elTotalBooths.textContent=map.size;
  const pairs=[...map.entries()].map(([norm,v])=>{
    let label=[...v.names].sort((a,b)=>a.length-b.length)[0];
    if(v.names.size>1) label+=" *";
    return {booth:label,count:v.count};
  }).sort((a,b)=>b.count-a.count);

  const labels=pairs.map(p=>p.booth);
  const values=pairs.map(p=>p.count);
  if(chart) chart.destroy();
  chart=new Chart(canvas,{
    type:"bar",
    data:{labels,datasets:[{label:"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà Check-in (status=IN)",data:values,
                            backgroundColor:"rgba(37,99,235,.75)",borderRadius:8}]},
    options:{responsive:true,maintainAspectRatio:false,
      scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{ticks:{autoSkip:false}}}}
  });
}

/* ===== INIT ===== */
btnLogout.onclick=()=>{location.href="signin.html";};
elDateSelect.onchange=()=>loadChartByDate(elDateSelect.value);

(async()=>{
  const dates = await loadAvailableDates();
  if(dates.length){
    elDateSelect.value = dates[dates.length-1]; // default = ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    loadChartByDate(dates[dates.length-1]);
  }
})();
</script>
</body>
</html>
