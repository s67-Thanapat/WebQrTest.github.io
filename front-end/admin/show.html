<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - QR Codes</title>
<style>
  :root{
    --bg:#f7f8fc; --fg:#0b1220; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
    --accent:#2563eb; --accent-2:#1e40af; --danger:#dc2626;
    --board-h:#f1f5f9; --row-a:#ffffff; --row-b:#f9fafb; --glow:0 6px 18px rgba(2,6,23,.06);
    --focus:#93c5fd; --chip:#f8fafc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  h1{margin:0 0 14px;font-size:22px;text-align:center}
  .info-bar{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px 14px;box-shadow:var(--glow);flex-wrap:wrap;justify-content:center}
  .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-weight:700}
  .clock{font-weight:800;letter-spacing:.5px}
  .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
  .btn:hover{background:var(--accent-2)}
  .btn-ghost{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn-del{background:var(--danger);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .board{margin-top:12px;border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--glow);background:var(--card)}
  .chart-wrap{padding:8px 16px 16px}
  .chart-container{position:relative;height:380px;width:100%;max-width:980px;margin:8px auto}
  .filter-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:0 16px 8px}
  .base-check{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  .base-check input{accent-color:#2563eb}
  .filter-actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  @media(max-width:720px){.chart-container{height:300px}}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
</head>
<body>
<div class="wrap">
  <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - QR Codes</h1>

  <!-- Summary -->
  <div class="info-bar">
    <div class="chip">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalUsers">‚Äî</span></div>
    <div class="chip">üß© ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalBases">‚Äî</span></div>
    <div class="chip">üë§ ‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalAttendees">‚Äî</span></div>
    <div class="chip clock" id="clock">--:--:--</div>
    <button class="btn-del" id="btnLogout">üö™ Logout</button>
  </div>

  <!-- Chart -->
  <div class="board">
    <h2 style="padding:10px 16px 0">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô (‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 8)</h2>
    <div class="chart-wrap">
      <div class="filter-row">
        <div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô: <span id="selCount">0</span>/8</div>
        <div id="baseChecks" style="display:flex;flex-wrap:wrap;gap:8px"></div>
        <div class="filter-actions">
          <button class="btn-ghost" id="btnPickAll">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button class="btn-ghost" id="btnPickNone">‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button class="btn" id="btnReload">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>
      <div class="chart-container"><canvas id="chartBase"></canvas></div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL="https://yowjvmiosrclqstoeqat.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const tz="Asia/Bangkok";
const fmtTime=new Intl.DateTimeFormat("th-TH",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false,timeZone:tz});

/* Clock */
setInterval(()=>{
  document.getElementById("clock").textContent=fmtTime.format(new Date());
},1000);

/* Elements */
const totalUsers=document.getElementById("totalUsers");
const totalAttendees=document.getElementById("totalAttendees");
const totalBases=document.getElementById("totalBases");
const baseChecks=document.getElementById("baseChecks");
const selCount=document.getElementById("selCount");
const btnPickAll=document.getElementById("btnPickAll");
const btnPickNone=document.getElementById("btnPickNone");
const btnReload=document.getElementById("btnReload");
const btnLogout=document.getElementById("btnLogout");
const chartCanvas=document.getElementById("chartBase");
let chart;
const MAX_PICK=8;

/* Local Storage for selected bases */
function loadSelected(){try{return new Set(JSON.parse(localStorage.getItem("selected_booths")||"[]"))}catch{return new Set()}}
function saveSelected(){localStorage.setItem("selected_booths",JSON.stringify([...selectedBases]))}
let selectedBases=loadSelected();

/* Main Chart Loader */
async function loadChart(){
  // 1. ‡∏î‡∏∂‡∏á UUID ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å genqrcode
  const {data:gq}=await supabase.from("genqrcode").select("uuid");
  const validUUIDs=new Set((gq||[]).map(r=>r.uuid));
  totalUsers.textContent=validUUIDs.size;

  // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å checkins (‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï booth = null)
  const {data:ci,error}=await supabase.from("checkins").select("booth,uuid");
  if(error){alert("‡πÇ‡∏´‡∏•‡∏î checkins ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+error.message);return;}
  const rows=(ci||[]).filter(r=>r.uuid&&validUUIDs.has(r.uuid));

  // 3. ‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏ê‡∏≤‡∏ô
  const map=new Map();
  for(const r of rows){
    const booth=(r.booth?.trim()||"(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ê‡∏≤‡∏ô)");
    if(!map.has(booth)) map.set(booth,new Set());
    map.get(booth).add(r.uuid);
  }
  const pairs=[...map.entries()].map(([booth,set])=>({booth,count:set.size}));
  pairs.sort((a,b)=>b.count-a.count);
  totalAttendees.textContent=rows.length;
  totalBases.textContent=pairs.length;

  // 4. Render checkbox
  renderChecks(pairs.map(p=>p.booth));

  // 5. Filter & Draw
  const view=(selectedBases.size===0)?pairs.slice(0,MAX_PICK):pairs.filter(p=>selectedBases.has(p.booth)).slice(0,MAX_PICK);
  const labels=view.map(p=>p.booth);
  const dataVals=view.map(p=>p.count);
  if(chart) chart.destroy();
  chart=new Chart(chartCanvas,{
    type:"bar",
    data:{labels,datasets:[{label:"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô (UUID ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)",data:dataVals,backgroundColor:"rgba(37,99,235,.75)",borderRadius:8}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}
  });
}

/* Render Checkbox */
function renderChecks(booths){
  baseChecks.innerHTML="";
  if(selectedBases.size===0){booths.slice(0,MAX_PICK).forEach(b=>selectedBases.add(b));saveSelected();}
  booths.forEach(b=>{
    const id="chk_"+b.replace(/\W/g,'_');
    const lbl=document.createElement("label");
    lbl.className="base-check";
    lbl.innerHTML=`<input type="checkbox" id="${id}" ${selectedBases.has(b)?"checked":""}/> ${b}`;
    baseChecks.appendChild(lbl);
    lbl.querySelector("input").onchange=(e)=>{
      if(e.target.checked){
        if(selectedBases.size>=MAX_PICK){e.target.checked=false;return;}
        selectedBases.add(b);
      }else selectedBases.delete(b);
      saveSelected();updateSelCount(booths.length);loadChart();
    };
  });
  updateSelCount(booths.length);
}
function updateSelCount(total){
  selCount.textContent=selectedBases.size;
  const reached=selectedBases.size>=MAX_PICK;
  baseChecks.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
    chk.disabled=!chk.checked&&reached;
  });
}

/* Control Buttons */
btnPickAll.onclick=()=>{selectedBases=new Set([...baseChecks.querySelectorAll("label")].map(l=>l.textContent.trim()));saveSelected();loadChart();}
btnPickNone.onclick=()=>{selectedBases.clear();saveSelected();loadChart();}
btnReload.onclick=()=>loadChart();
btnLogout.onclick=()=>{window.location.href="signin.html";}

/* Init */
loadChart();
</script>
</body>
</html>
