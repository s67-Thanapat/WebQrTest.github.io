<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Check-ins by Date (status = IN)</title>
<style>
  :root{
    --bg:#f7f8fc; --fg:#0b1220; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
    --accent:#2563eb; --danger:#dc2626; --board-h:#f1f5f9; --glow:0 6px 18px rgba(2,6,23,.06);
    --chip:#f8fafc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  h1{text-align:center;margin:0 0 14px;font-size:22px}
  .info-bar{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;
    background:var(--card);border:1px solid var(--border);border-radius:14px;
    box-shadow:var(--glow);padding:12px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);
    border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-weight:700}
  .clock{font-weight:800}
  .btn-del{background:var(--danger);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  select{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:600}
  .board{margin-top:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--glow)}

  /* header ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: h2 ‡∏ã‡πâ‡∏≤‡∏¢ / chip+select ‡∏Ç‡∏ß‡∏≤ */
  .board-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px 0}
  .board-header h2{margin:0;font-size:18px}
  .right-group{display:flex;align-items:center;gap:12px}
  .muted{color:var(--muted);margin:0 16px 8px}
  .chart-container{position:relative;height:380px;width:100%;max-width:980px;margin:8px auto}
  @media(max-width:720px){
    .chart-container{height:300px}
    .right-group{flex-wrap:wrap;justify-content:flex-end}
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
</head>
<body>
<div class="wrap">
  <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</h1>

  <div class="info-bar">
    <div class="chip">üßæ ‡∏ú‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalGenQR">‚Äî</span> ‡∏Ñ‡∏ô</div>
    <div class="chip">‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡πÄ‡∏•‡πâ‡∏ß: <span id="totalIn">‚Äî</span> ‡∏Ñ‡∏ô</div>
    <div class="chip">üß© ‡∏ö‡∏π‡∏ò‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalBooths">‚Äî</span> ‡∏ê‡∏≤‡∏ô</div>
    <div class="chip clock" id="clock"> </div>
    <button class="btn-del" id="btnLogout">Logout</button>
  </div>

  <div class="board">
    <div class="board-header">
      <h2>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏π‡∏ò</h2>
      <div class="right-group">
        <div class="chip">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <span id="selectedDateText">‚Äî</span></div>
        <select id="dateSelect"></select>
      </div>
    </div>
    <p class="muted" id="subtitle">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
    <div class="chart-container"><canvas id="chart"></canvas></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL="https://yowjvmiosrclqstoeqat.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const tz = "Asia/Bangkok";
const fmtFull = new Intl.DateTimeFormat("th-TH",{dateStyle:"medium",timeStyle:"medium",hour12:false,timeZone:tz});
const fmtDateTH = new Intl.DateTimeFormat("th-TH",{dateStyle:"medium",timeZone:tz});

/* üëá ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á genqrcode (‡πÄ‡∏ä‡πà‡∏ô created_at / issued_at) */
const GENQR_TIME_COL = "created_at";

/* ===== ELEMENTS ===== */
const elClock=document.getElementById("clock");
const elTotalIn=document.getElementById("totalIn");
const elTotalBooths=document.getElementById("totalBooths");
const elTotalGenQR=document.getElementById("totalGenQR");
const elDateSelect=document.getElementById("dateSelect");
const elDateText=document.getElementById("selectedDateText");
const elSubtitle=document.getElementById("subtitle");
const btnLogout=document.getElementById("btnLogout");
const canvas=document.getElementById("chart");
let chart;

/* ===== CLOCK (‡∏ß‡∏±‡∏ô+‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢) ===== */
function tick(){ elClock.textContent = fmtFull.format(new Date()); }
tick(); setInterval(tick,1000);

/* ===== HELPERS ===== */
function normalizeBoothName(s){
  if(!s) return "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ê‡∏≤‡∏ô)";
  return s.trim().replace(/\s+/g," ").toLowerCase();
}
function toLocalDateOnly(iso){
  const d=new Date(iso);
  return d.toLocaleDateString("en-CA",{timeZone:tz}); // yyyy-MM-dd
}
function dayBounds(dateStr){
  const start = new Date(dateStr+"T00:00:00+07:00").toISOString();
  const end = new Date(new Date(dateStr+"T00:00:00+07:00").getTime()+86400000).toISOString();
  return [start,end];
}

/* ===== GENQRCODE SUMMARY (‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ===== */
async function loadGenQR(dateStr){
  let q = supabase.from("genqrcode").select("id",{count:"exact",head:true});
  if(dateStr && dateStr!=="ALL"){
    const [start,end] = dayBounds(dateStr);
    q = q.gte(GENQR_TIME_COL,start).lt(GENQR_TIME_COL,end);
  }
  const { count, error } = await q;
  if(error){ console.warn("‡πÇ‡∏´‡∏•‡∏î genqrcode ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error.message); }
  elTotalGenQR.textContent = count ?? "‚Äî";
}

/* ===== ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å checkins (‡πÄ‡∏û‡∏¥‡πà‡∏° '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') ===== */
async function loadAvailableDates(){
  const { data, error } = await supabase
    .from("checkins")
    .select("checkin_time")
    .order("checkin_time",{ascending:true});

  if(error){ alert("‡πÇ‡∏´‡∏•‡∏î checkin_time ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: "+error.message); return []; }

  const set=new Set();
  for(const r of data){ if(r.checkin_time) set.add(toLocalDateOnly(r.checkin_time)); }
  const list=[...set].sort();                // yyyy-MM-dd
  const options = ['ALL', ...list];          // ‡πÉ‡∏™‡πà ‚Äú‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù ‡πÑ‡∏ß‡πâ‡∏´‡∏±‡∏ß‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

  elDateSelect.innerHTML = options.map(d=>{
    const label = (d==='ALL') ? "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : fmtDateTH.format(new Date(d));
    return `<option value="${d}">${label}</option>`;
  }).join("");

  return options;
}

/* ===== ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô (‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ===== */
async function loadChartByDate(dateStr){
  // label ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
  elDateText.textContent = (dateStr==="ALL") ? "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : fmtDateTH.format(new Date(dateStr));
  elSubtitle.textContent = (dateStr==="ALL") ? "‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : "‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";

  // ‡∏ú‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (genqrcode) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  await loadGenQR(dateStr);

  // ‡∏î‡∏∂‡∏á checkins
  let q = supabase
    .from("checkins")
    .select("booth,status,checkin_time")
    .eq("status","IN");
  if(dateStr && dateStr!=="ALL"){
    const [start,end] = dayBounds(dateStr);
    q = q.gte("checkin_time", start).lt("checkin_time", end);
  }

  const { data, error } = await q.range(0,99999);
  if(error){ alert("‡πÇ‡∏´‡∏•‡∏î checkins ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+error.message); return; }

  // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ö‡∏π‡∏ò
  const map=new Map();
  for(const r of data){
    const booth=(r.booth?.trim()||"(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ê‡∏≤‡∏ô)");
    const norm=normalizeBoothName(booth);
    if(!map.has(norm)) map.set(norm,{names:new Set(),count:0});
    const o=map.get(norm);
    o.names.add(booth);
    o.count++;
  }

  // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏ß‡∏°
  elTotalIn.textContent=data.length||0;
  elTotalBooths.textContent=map.size;

  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü
  const pairs=[...map.entries()].map(([norm,v])=>{
    let label=[...v.names].sort((a,b)=>a.length-b.length)[0];
    if(v.names.size>1) label+=" *";
    return {booth:label,count:v.count};
  }).sort((a,b)=>b.count-a.count);

  const labels=pairs.map(p=>p.booth);
  const values=pairs.map(p=>p.count);

  // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
  if(chart) chart.destroy();
  chart=new Chart(canvas,{
    type:"bar",
    data:{labels,datasets:[{label:"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà Check-in ",data:values,
                            backgroundColor:"rgba(37,99,235,.75)",borderRadius:8}]},
    options:{responsive:true,maintainAspectRatio:false,
      scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{ticks:{autoSkip:false}}}}
  });
}

/* ===== INIT ===== */
btnLogout.onclick=()=>{location.href="signin.html";};
elDateSelect.onchange=()=>loadChartByDate(elDateSelect.value);

(async()=>{
  const options = await loadAvailableDates();       // ['ALL', ...dates]
  // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‚Äù; ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏ä‡πâ ‚Äú‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù
  let defaultVal = "ALL";
  if(options.length > 1){ defaultVal = options[options.length-1]; } // ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  elDateSelect.value = defaultVal;
  loadChartByDate(defaultVal);
})();
</script>
</body>
</html>
