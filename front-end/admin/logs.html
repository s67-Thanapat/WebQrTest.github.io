<!DOCTYPE html>
<html lang="th" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Audit Logs (Admin)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; padding:20px; background:#f9fafb; }
    h1 { font-size:1.6rem; margin-bottom:0.5rem; }
    input, button { padding:8px 12px; margin:4px; border-radius:6px; border:1px solid #ccc; }
    button { cursor:pointer; font-weight:600; }
    table { border-collapse: collapse; margin-top:20px; width:100%; font-size:0.95rem; }
    th, td { border:1px solid #ddd; padding:6px 8px; text-align:center; }
    th { background:#f3f4f6; }
    .muted { color:#6b7280; font-size:0.9rem; }
    .wide { text-align:left; max-width:320px; overflow-wrap:anywhere; }
  </style>
</head>
<body>
  <h1>Audit Logs</h1>

  <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏° login/logout -->
  <div>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="signup()">Register</button>
    <button onclick="logout()">Logout</button>
    <p id="me" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</p>
  </div>

  <hr>

  <button onclick="loadLogs()">üìã ‡πÇ‡∏´‡∏•‡∏î Logs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>

  <table id="tbl">
    <thead>
      <tr>
        <th>ID</th>
        <th>Table</th>
        <th>Op</th>
        <th>Row</th>
        <th>User</th>
        <th>Time</th>
        <th>Old Data</th>
        <th>New Data</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  // ========== CONFIG ==========
  const SUPABASE_URL = "https://yowjvmiosrclqstoeqat.supabase.co";   // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";                 // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ========== Auth ==========
  async function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return alert(error.message);
    alert("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    showMe();
  }
  async function signup() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) return alert(error.message);
    alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•");
  }
  async function logout() {
    await supabase.auth.signOut();
    alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
    showMe();
  }
  async function showMe() {
    const { data: { user } } = await supabase.auth.getUser();
    document.getElementById("me").textContent = user
      ? `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ${user.email}`
      : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô";
  }
  supabase.auth.onAuthStateChange(showMe);

  async function getToken() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
    return session.access_token;
  }

  // ========== Load Logs ==========
  async function loadLogs() {
    try {
      const token = await getToken();
      // üëâ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ view audit.v_audit_logs ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡πÑ‡∏î‡πâ (‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô display_name)
      const res = await fetch(`${SUPABASE_URL}/rest/v1/audit_logs?select=*`, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${token}`
        }
      });
      if (!res.ok) throw new Error(await res.text());
      const rows = await res.json();
      renderTable(rows);
    } catch (e) {
      alert("‡πÇ‡∏´‡∏•‡∏î log ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
    }
  }

  // ========== Render ==========
  function renderTable(rows) {
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";
    for (const r of rows.sort((a,b)=>b.id-a.id).slice(0,50)) { // ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.table_name}</td>
        <td>${r.operation}</td>
        <td>${r.row_id || ""}</td>
        <td>${r.changed_by || ""}</td>
        <td>${new Date(r.changed_at).toLocaleString()}</td>
        <td class="wide">${JSON.stringify(r.old_data) || ""}</td>
        <td class="wide">${JSON.stringify(r.new_data) || ""}</td>`;
      tbody.appendChild(tr);
    }
  }

  // init
  showMe();
</script>
</body>
</html>
