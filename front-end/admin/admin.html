<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - QR Codes</title>
  <style>
    :root{ --bg:#0b0c10; --fg:#e5e7eb; --muted:#9ca3af; --card:#111318; --accent:#2563eb; --accent-2:#1d4ed8; --danger:#dc2626; --border:rgba(255,255,255,.08); }
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:20px auto;padding:16px}
    h1{margin:0 0 12px}
    .bar{display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);padding:10px;border-radius:12px}
    .spacer{flex:1}
    input[type="search"]{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg);min-width:320px}
    button{padding:8px 12px;border:none;border-radius:10px;cursor:pointer}
    .btn{background:var(--accent);color:#fff}.btn:hover{background:var(--accent-2)}
    .btn-ghost{background:transparent;color:var(--fg);border:1px solid var(--border)}
    .btn-del{background:var(--danger);color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid var(--border);padding:10px;text-align:left}
    th{background:#14161d}
    tr:nth-child(even){background:#0f1117}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .foot{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
    select{background:transparent;color:var(--fg);border:1px solid var(--border);border-radius:8px;padding:6px}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55)}
    .modal.show{display:grid}
    .card{background:var(--card);border:1px solid var(--border);padding:16px;border-radius:12px;min-width:320px}
    .card h3{margin:0 0 10px}
    .card label{font-size:12px;color:var(--muted)}
    .card input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg)}
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - QR Codes</h1>

    <div class="bar">
      <button class="btn" id="btnReload">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="btn-ghost" id="btnExport">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
      <button class="btn-del" id="btnBulkDelete">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      <span class="spacer"></span>

      <input id="search" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." autocomplete="off" />

      <button class="btn-ghost" id="btnCheckMe">üîé ‡πÄ‡∏ó‡∏™ backend</button>
      <button class="btn-ghost" id="btnLogs">üìú Logs</button>
      <button class="btn-ghost" id="btnResetPw">üîë ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
      <button class="btn-ghost" id="btnLogout">üö™ Logout</button>
    </div>

    <table id="qrTable" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ QR Codes">
      <thead>
        <tr>
          <th style="width:36px"><input type="checkbox" id="checkAll"></th>
          <th>ID</th>
          <th>Code</th>
          <th>User Agent</th>
          <th>Created At</th>
          <th class="right">Action</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td class="muted" colspan="6">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
    </table>

    <div class="foot">
      <div id="countLabel" class="muted">‚Äî</div>
      <div>‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
        <select id="pageSize"><option>10</option><option selected>20</option><option>50</option><option>100</option></select>
        <span id="pageInfo" class="muted" style="margin-left:8px">‡∏´‡∏ô‡πâ‡∏≤ 1/1</span>
      </div>
    </div>
  </div>

  <!-- Modal Reset Password -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="card">
      <h3>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
      <label>Email</label>
      <input id="mEmail" type="email" placeholder="user@example.com" />
      <label style="margin-top:8px">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
      <input id="mPassword" type="password" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß" />
      <div id="mMsg" class="muted" style="margin-top:6px"></div>
      <div class="row">
        <button class="btn-ghost" id="mCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn" id="mSubmit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = "https://yowjvmiosrclqstoeqat.supabase.co";   // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/* ‚úÖ ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
const TABLE = "qr_codes";
const COLS = { id:"id", code:"uuid", ua:"user_agent", createdAt:"created_at" };

/* ---------- ELEMENTS ---------- */
const tbody = document.getElementById("tbody");
const btnReload = document.getElementById("btnReload");
const btnExport = document.getElementById("btnExport");
const btnBulkDelete = document.getElementById("btnBulkDelete");
const btnLogout = document.getElementById("btnLogout");
const btnCheckMe = document.getElementById("btnCheckMe");
const btnLogs = document.getElementById("btnLogs");
const search = document.getElementById("search");
const checkAll = document.getElementById("checkAll");
const pageSize = document.getElementById("pageSize");
const pageInfo = document.getElementById("pageInfo");
const countLabel = document.getElementById("countLabel");
const tzFmt = new Intl.DateTimeFormat('th-TH',{dateStyle:'medium', timeStyle:'medium', hour12:false, timeZone:'Asia/Bangkok'});

/* Modal elems */
const modal = document.getElementById("modal");
const mEmail = document.getElementById("mEmail");
const mPassword = document.getElementById("mPassword");
const mMsg = document.getElementById("mMsg");
document.getElementById("btnResetPw").onclick = () => { mEmail.value=""; mPassword.value=""; mMsg.textContent=""; modal.classList.add("show"); };
document.getElementById("mCancel").onclick = () => modal.classList.remove("show");
document.getElementById("mSubmit").onclick = adminResetPassword;

/* ---------- SESSION GATE ---------- */
(async () => {
  const { data:{ session } } = await supabase.auth.getSession();
  if (!session) { window.location.href = "login.html"; return; }
  search.value = ""; setTimeout(() => search.value = "", 0);
  loadData();
})();

/* ---------- STATE / RENDER ---------- */
const st = { raw:[], filtered:[], page:1, pageSize:20 };
function fmtDate(iso){const d = new Date(iso);return isNaN(d)? "-" : tzFmt.format(d);}
function applyFilter(){
  let q=(search.value||"").trim().toLowerCase();
  if (q.includes('@')) q = "";
  st.filtered = st.raw.filter(r=>{
    if(!q) return true;
    return String(r[COLS.id]).toLowerCase().includes(q)
        || String(r[COLS.code]||"").toLowerCase().includes(q)
        || String(r[COLS.ua]||"").toLowerCase().includes(q);
  });
  st.page=1;
}
function getPageData(){const start=(st.page-1)*st.pageSize;return st.filtered.slice(start,start+st.pageSize);}
function render(){
  const rows = getPageData();
  if(rows.length===0){
    tbody.innerHTML = `<tr><td colspan="6" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
  }else{
    tbody.innerHTML = "";
    for(const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="rowcheck" value="${r[COLS.id]}"></td>
        <td>${r[COLS.id]}</td>
        <td><span>${r[COLS.code] ?? ""}</span></td>
        <td class="muted" title="${r[COLS.ua]||""}">${r[COLS.ua]||"-"}</td>
        <td>${fmtDate(r[COLS.createdAt])}</td>
        <td class="right"><button class="btn-del" data-del="${r[COLS.id]}">‡∏•‡∏ö</button></td>`;
      tbody.appendChild(tr);
    }
    tbody.querySelectorAll("[data-del]").forEach(btn=>btn.onclick=()=>deleteRow(btn.dataset.del));
  }
  const total = st.filtered.length;
  const pages = Math.max(1, Math.ceil(total/st.pageSize));
  if(st.page>pages) st.page=pages;
  pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${st.page}/${pages}`;
  countLabel.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
}

/* ---------- CRUD ---------- */
async function loadData(){
  tbody.innerHTML = `<tr><td colspan="6" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;
  const { data, error } = await supabase
    .from(TABLE)
    .select([COLS.id, COLS.code, COLS.ua, COLS.createdAt].join(","))
    .order(COLS.createdAt,{ascending:false})
    .limit(1000);
  if(error){ tbody.innerHTML = `<tr><td colspan="6">‚ùå ${error.message}</td></tr>`; return; }
  st.raw = data||[]; applyFilter(); render();
}
async function deleteRow(id){
  if(!confirm(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (${id})`)) return;
  const { error } = await supabase.from(TABLE).delete().eq(COLS.id, id);
  if(error){ alert("‚ùå "+error.message); return; }
  st.raw = st.raw.filter(x=>String(x[COLS.id])!==String(id));
  applyFilter(); render();
}

/* ---------- EXPORT CSV ---------- */
function toCsvValue(v){
  if (v==null) return "";
  const s = String(v);
  if (s.includes('"') || s.includes(',') || s.includes('\n')) {
    return `"${s.replace(/"/g,'""')}"`;
  }
  return s;
}
btnExport.onclick = ()=>{
  const rows = st.filtered.map(r=>({
    id: r[COLS.id],
    code: r[COLS.code] ?? "",
    user_agent: r[COLS.ua] ?? "",
    created_at: r[COLS.createdAt] ?? ""
  }));
  const header = ["id","code","user_agent","created_at"];
  const csv = [
    header.join(","),
    ...rows.map(obj => header.map(k => toCsvValue(obj[k])).join(","))
  ].join("\n");
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const dt = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.href = url; a.download = `qrcodes-${dt}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

/* ---------- ‡∏•‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ---------- */
btnBulkDelete.onclick = async ()=>{
  const ids = [...document.querySelectorAll(".rowcheck:checked")].map(cb=>cb.value);
  if (ids.length===0) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ñ‡∏ß"); return; }
  if (!confirm(`‡∏•‡∏ö ${ids.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
  const { error } = await supabase.from(TABLE).delete().in(COLS.id, ids);
  if (error) { alert("‚ùå "+error.message); return; }
  st.raw = st.raw.filter(x=>!ids.includes(String(x[COLS.id])));
  checkAll.checked = false; applyFilter(); render();
};

/* ---------- UI EVENTS ---------- */
btnReload.onclick = loadData;
search.addEventListener('keyup', ()=>{ applyFilter(); render(); });
search.addEventListener('search', ()=>{ applyFilter(); render(); });
pageSize.onchange = ()=>{ st.pageSize=parseInt(pageSize.value,10); render(); };
checkAll.onchange = ()=>{ document.querySelectorAll(".rowcheck").forEach(cb=> cb.checked = checkAll.checked); };
btnLogout.onclick = async ()=>{ await supabase.auth.signOut(); window.location.href="login.html"; };

/* ---------- LOGS BUTTON (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ admin) ---------- */
btnLogs.onclick = async () => {
  const { data:{ session } } = await supabase.auth.getSession();
  if (!session) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô"); return; }
  const userId = session.user.id;

  const { data, error } = await supabase
    .from("profiles")
    .select("is_admin")
    .eq("id", userId)
    .maybeSingle();  // ‚úÖ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤ single()

  if (error) { alert("‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message); return; }
  if (!data) { alert("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"); return; }

  if (data.is_admin) {
    window.location.href = "logs.html";
  } else {
    alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤ Logs (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)");
  }
};

/* ---------- ADMIN RESET PASSWORD (‡∏ú‡πà‡∏≤‡∏ô backend ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---------- */
async function adminResetPassword(){
  const email = (mEmail.value||"").trim();
  const pw = (mPassword.value||"").trim();
  mMsg.textContent = "";
  if (!email) { mMsg.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•"; return; }
  if (!pw || pw.length < 6) { mMsg.textContent = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£"; return; }
  // TODO: ‡πÉ‡∏™‡πà BACKEND_BASE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏∞ endpoint ‡∏à‡∏£‡∏¥‡∏á
  mMsg.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠ backend ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô";
}

/* ---------- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ó‡∏™‡∏î‡∏≤‡∏ï‡πâ‡∏≤ ---------- */
btnCheckMe.onclick = async () => {
  try {
    const { data, error } = await supabase
      .from(TABLE)
      .select([COLS.id, COLS.code, COLS.ua, COLS.createdAt].join(","))
      .limit(1);
    if (error) { alert("‚ùå " + error.message); return; }
    alert("‚úÖ OK: " + JSON.stringify(data?.[0] || null, null, 2));
  } catch (e) {
    alert("‚ùå Exception: " + e.message);
  }
};
</script>
</body>
</html>
