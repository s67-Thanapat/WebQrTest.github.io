<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - QR Codes</title>
  <style>
    :root{
      --bg:#0b0c10; --fg:#e5e7eb; --muted:#9ca3af; --card:#111318;
      --accent:#2563eb; --accent-2:#1d4ed8; --danger:#dc2626; --border:rgba(255,255,255,.08);
      --board-h:#1c1f27; --row-a:#14161d; --row-b:#0f1117; --glow:0 8px 32px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:20px auto;padding:16px}
    h1{margin:0 0 12px}

    /* Info bar */
    .info-bar{display:flex;gap:16px;align-items:center;background:var(--card);
      border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:var(--glow)}
    .chip{display:inline-flex;align-items:center;gap:8px;background:#0f1117;
      border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-weight:700}
    .muted{color:var(--muted)}
    .clock{margin-left:auto;font-weight:800;letter-spacing:.5px}

    /* Toolbar */
    .bar{display:flex;gap:8px;align-items:center;background:var(--card);
      border:1px solid var(--border);padding:10px;border-radius:12px;margin-top:12px}
    .spacer{flex:1}
    input[type="search"]{padding:8px 10px;border-radius:10px;border:1px solid var(--border);
      background:transparent;color:var(--fg);min-width:300px}
    button{padding:8px 12px;border:none;border-radius:10px;cursor:pointer}
    .btn{background:var(--accent);color:#fff}.btn:hover{background:var(--accent-2)}
    .btn-ghost{background:transparent;color:var(--fg);border:1px solid var(--border)}
    .btn-del{background:var(--danger);color:#fff}

    /* Flight board table */
    .board{margin-top:12px;border:2px solid #2a2e3a;border-radius:10px;overflow:hidden;box-shadow:var(--glow)}
    table{width:100%;border-collapse:collapse;font-size:15px;table-layout:fixed}
    thead th{background:var(--board-h);text-transform:uppercase;letter-spacing:.4px;
      padding:12px 10px;border-bottom:1px solid #2a2e3a}
    tbody td{padding:12px 10px;border-bottom:1px solid #151822}
    tbody tr:nth-child(odd){background:var(--row-a)}
    tbody tr:nth-child(even){background:var(--row-b)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    thead th, tbody td { text-align:center; vertical-align:middle; }

    /* Footer + notice */
    .foot{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .notice{margin-top:6px;color:#fbbf24;font-size:13px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - QR Codes</h1>

    <!-- Summary -->
    <div class="info-bar">
      <div class="chip">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalUsers"  class="mono">‚Äî</span>‡∏Ñ‡∏ô</div>
      <div class="chip">üóÑÔ∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ê‡∏≤‡∏ô: <span id="totalTables" class="mono">‚Äî</span>‡∏ê‡∏≤‡∏ô</div>
      <div class="clock" id="clock">--:--:--</div>
    </div>

    <!-- Toolbar -->
    <div class="bar">
      <button class="btn" id="btnReload">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <span class="spacer"></span>
      <input id="search" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (ID / Code / User Agent)" autocomplete="off" />
      <button class="btn-ghost" id="btnExport">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
      <button class="btn-del" id="btnLogout">üö™ Logout</button>
    </div>

    <!-- Flight-board style table -->
    <div class="board">
      <table aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ QR Codes">
        <thead>
          <tr>
            <th style="width:80px">ID</th>
            <th style="width:120px">Time</th>
            <th>UUID</th>
            <th>User-Code-Name</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="4" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
      </table>
    </div>

    <div class="foot">
      <div id="countLabel" class="muted">‚Äî</div>
      <div class="muted">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate">‚Äî</span></div>
    </div>
    <div id="notice" class="notice"></div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = "https://yowjvmiosrclqstoeqat.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU"; // ‡πÉ‡∏™‡πà key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const tz = 'Asia/Bangkok';
const fmtTime = new Intl.DateTimeFormat('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:tz});
const fmtFull = new Intl.DateTimeFormat('th-TH',{dateStyle:'medium', timeStyle:'medium', hour12:false, timeZone:tz});

/* ---------- ELEMENTS ---------- */
const tbody=document.getElementById("tbody");
const totalUsers=document.getElementById("totalUsers");
const totalTables=document.getElementById("totalTables");
const clock=document.getElementById("clock");
const btnReload=document.getElementById("btnReload");
const btnExport=document.getElementById("btnExport");
const btnLogout=document.getElementById("btnLogout");
const search=document.getElementById("search");
const countLabel=document.getElementById("countLabel");
const lastUpdate=document.getElementById("lastUpdate");
const notice=document.getElementById("notice");

/* ---------- CLOCK ---------- */
setInterval(()=>{ clock.textContent = fmtTime.format(new Date()); },1000);

/* ---------- SUMMARY: ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å qrcodes ---------- */
async function loadSummary(){
  // 1) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ô‡∏±‡∏ö "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥" ‡∏î‡πâ‡∏ß‡∏¢ RPC count_distinct_codes()
  try{
    const { data, error } = await supabase.rpc("count_distinct_codes");
    if (error) throw error;
    if (typeof data === "number") {
      totalUsers.textContent = data;
    } else {
      // ‡∏ñ‡πâ‡∏≤ RPC ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÉ‡∏´‡πâ fallback
      throw new Error("RPC returned non-number");
    }
  }catch(e){
    console.warn("[summary] RPC count_distinct_codes failed, fallback to total rows:", e?.message || e);
    // 2) fallback: ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á qrcodes (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà distinct)
    try{
      const { count, error } = await supabase
        .from("qrcodes")
        .select("id", { count: "exact", head: true });
      if (error) throw error;
      totalUsers.textContent = (typeof count === "number") ? count : "‚Äî";
      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ö‡∏≤ ‡πÜ ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ fallback
      notice.textContent = "‚ÑπÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (fallback) ‚Äî ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏£‡πâ‡∏≤‡∏á RPC 'count_distinct_codes' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥";
    }catch(e2){
      console.warn("[summary] fallback count qrcodes failed:", e2?.message || e2);
      totalUsers.textContent = "‚Äî";
    }
  }

  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ê‡∏≤‡∏ô (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
  try{
    const { data, error } = await supabase.rpc("get_table_count");
    if (error) throw error;
    totalTables.textContent = data ?? "‚Äî";
  }catch(e){
    totalTables.textContent = "‚Äî";
  }
}

/* ---------- TABLE: last 1h (‚â§25) with fallback ---------- */
let RAW=[];
async function loadTable(){
  tbody.innerHTML=`<tr><td colspan="4" class="muted">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;
  // ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏±‡∏ö notice ‡∏à‡∏≤‡∏Å summary ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÅ‡∏™‡∏î‡∏á fallback
  const prevNotice = notice.textContent;

  const oneHourAgo=new Date(Date.now()-60*60*1000).toISOString();
  let { data, error } = await supabase.from("qrcodes")
    .select("id,code,user_agent,created_at")
    .gte("created_at",oneHourAgo)
    .order("created_at",{ascending:false})
    .limit(25);

  if(error){
    tbody.innerHTML=`<tr><td colspan="4">‚ùå ${error.message}</td></tr>`;
    return;
  }

  // fallback: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏¢‡πÉ‡∏ô 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‚Üí ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 25 ‡πÅ‡∏ñ‡∏ß
  if(!data || data.length===0){
    const res = await supabase.from("qrcodes")
      .select("id,code,user_agent,created_at")
      .order("created_at",{ascending:false})
      .limit(25);
    if(!res.error){ data = res.data; }
    notice.textContent = prevNotice || "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏ó‡∏ô";
  } else {
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° notice ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å summary ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    notice.textContent = prevNotice || "";
  }

  RAW = data || [];
  renderTable();
  lastUpdate.textContent = fmtFull.format(new Date());
}

function renderTable(){
  const q=(search.value||"").trim().toLowerCase();
  const rows=RAW.filter(r=>{
    if(!q) return true;
    return String(r.id).toLowerCase().includes(q)
        || String(r.code||"").toLowerCase().includes(q)
        || String(r.user_agent||"").toLowerCase().includes(q);
  });

  if(rows.length===0){
    tbody.innerHTML=`<tr><td colspan="4" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
  }else{
    tbody.innerHTML = rows.map(r=>{
      const t = r.created_at ? fmtTime.format(new Date(r.created_at)) : "-";
      const ua = (r.user_agent||"-").replaceAll("<","&lt;").replaceAll(">","&gt;");
      const code = (r.code??"-").toString().replaceAll("<","&lt;").replaceAll(">","&gt;");
      return `
        <tr>
          <td class="mono">${r.id}</td>
          <td class="mono">${t}</td>
          <td class="mono nowrap" title="${code}">${code}</td>
          <td class="nowrap" title="${ua}">${ua}</td>
        </tr>`;
    }).join("");
  }
  countLabel.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏à‡∏≤‡∏Å ${RAW.length})`;
}

/* ---------- EVENTS ---------- */
btnReload.onclick = async ()=>{ await loadSummary(); await loadTable(); };
btnLogout.onclick = async ()=>{ await supabase.auth.signOut(); window.location.href="login.html"; };
search.addEventListener('input', renderTable);

/* ---------- EXPORT CSV ---------- */
btnExport.onclick = ()=>{
  if(!RAW.length) return;
  const header = ["id","time","code","user_agent"];
  const lines = [header.join(",")];
  RAW.forEach(r=>{
    const t = r.created_at ? new Date(r.created_at).toISOString() : "";
    const row = [
      `"${r.id}"`,
      `"${t}"`,
      `"${(r.code??"").toString().replaceAll('"','""')}"`,
      `"${(r.user_agent??"").replaceAll('"','""')}"`
    ];
    lines.push(row.join(","));
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `qrcodes_${Date.now()}.csv`; a.click();
  URL.revokeObjectURL(url);
};

/* ---------- INIT + AUTO REFRESH ---------- */
(async()=>{ await loadSummary(); await loadTable(); })();
setInterval(async()=>{ await loadSummary(); await loadTable(); }, 10000);
</script>
</body>
</html>
