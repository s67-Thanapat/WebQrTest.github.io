<!DOCTYPE html>
<html lang="th" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Login</title>
  <style>
    :root{--bg:#0b0c10;--fg:#e5e7eb;--card:#111318;--border:rgba(255,255,255,.1);--accent:#2563eb}
    body{margin:0;height:100dvh;display:grid;place-items:center;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto}
    .card{width:min(440px,92vw);background:var(--card);border:1px solid var(--border);padding:18px;border-radius:14px}
    h1{margin:0 0 10px}
    label{display:block;font-size:12px;opacity:.8;margin:8px 0 4px}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg)}
    button{width:100%;margin-top:12px;padding:10px;border:none;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
    .muted{opacity:.8;margin-top:8px;min-height:1lh}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <form class="card" id="f">
    <h1>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h1>
    <label>Email</label><input id="email" type="email" required autocomplete="username" />
    <label>Password</label><input id="pw" type="password" required autocomplete="current-password" />
    <button type="submit">üîê Login</button>
    <div id="msg" class="muted"></div>
  </form>

<script>
const SUPABASE_URL = "https://yowjvmiosrclqstoeqat.supabase.co"; // <- ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";                   // <- ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const BACKEND_BASE = "https://backend-github-io-mrli.vercel.app";  // <- ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true} });
const f = document.getElementById("f");
const email = document.getElementById("email");
const pw = document.getElementById("pw");
const msg = document.getElementById("msg");

// ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ session ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ä‡πá‡∏Ñ role ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
(async () => {
  const { data:{ session } } = await sb.auth.getSession();
  if (!session) return;
  if (await isAdmin(session.access_token)) location.href = "./app.html";
})();

f.addEventListener("submit", async (e)=>{
  e.preventDefault();
  msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";
  const { data, error } = await sb.auth.signInWithPassword({ email: email.value.trim(), password: pw.value });
  if (error) { msg.textContent = "‚ùå " + error.message; return; }

  const ok = await isAdmin(data.session.access_token);
  if (ok) {
    msg.textContent = "‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤...";
    location.href = "./app.html";
  } else {
    msg.textContent = "‚ùå ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô";
    await sb.auth.signOut();
  }
});

async function isAdmin(token){
  try{
    const r = await fetch(`${BACKEND_BASE}/admin/me`, { headers: { Authorization: "Bearer "+token }});
    const j = await r.json();
    return r.ok && j?.is_admin === true;
  }catch{ return false; }
}
</script>
</body>
</html>
